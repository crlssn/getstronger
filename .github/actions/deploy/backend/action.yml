name: Deploy backend

inputs:
  aws_access_key_id:
    description: "AWS Access Key ID"
    required: true
  aws_secret_access_key:
    description: "AWS Secret Access Key"
    required: true
  aws_region:
    description: "AWS Region"
    required: true
  aws_ec2_private_key:
    description: "AWS EC2 Private Key"
    required: true

runs:
  using: 'composite'
  steps:
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Build the app
      shell: bash
      working-directory: ./go
      run: |
        go mod download
        GOOS=linux go build -o cmd/bin cmd/main.go
        zip app.zip cmd/bin

    - name: Deploy to S3
      working-directory: ./go
      shell: bash
      env:
        AWS_ACCESS_KEY_ID: ${{ inputs.aws_access_key_id }}
        AWS_SECRET_ACCESS_KEY: ${{ inputs.aws_secret_access_key }}
        AWS_REGION: ${{ inputs.aws_region }}
        AWS_BUCKET_NAME: ${{ inputs.aws_bucket_name }}
      run: |
        # Sync the build folder to the S3 bucket
        aws s3 sync ./app.zip s3://getstronger-binaries

#    - name: Deploy to EC2
#      shell: bash
#      env:
#        EC2_HOST: "ip-172-31-36-227.eu-west-2.compute.internal"
#      run: |
#        chmod 600 ~/.ssh/id_rsa
#        scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ./app ec2-user@$EC2_HOST:~/app
#        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ec2-user@$EC2_HOST << EOF
#          pkill app || true
#          nohup ./app &
#        EOF
#
#      # Set up SSH for the EC2 connection
#    - name: Add SSH Key
#      uses: webfactory/ssh-agent@v0.5.3
#      with:
#        ssh-private-key: ${{ inputs.AWS_EC2_PRIVATE_KEY }}